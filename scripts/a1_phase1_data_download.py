# scripts/a1_phase1_data_download.py

import os
import glob
import math
import time
import ee
import certifi
from rich.progress import track
from config import RAW_DATA_DIR, TIMESTAMPS, CLOUDY_PIXEL_PERCENTAGE, BANDS, INDICES

# SSL fix for Earth Engine
os.environ["SSL_CERT_FILE"]   = certifi.where()
os.environ["CURL_CA_BUNDLE"]  = certifi.where()
os.environ.pop("REQUESTS_CA_BUNDLE", None)

MAX_PIXELS    = 1e13
MAX_TILE_SIZE = 0.05    # degrees per tile

# -----------------------------------------------------------------------------
# 1) HARD-CODED ISLAND POLYGONS
# -----------------------------------------------------------------------------
# Each "coords" is a single linear ring (lon,lat) list; EE will accept it.

islands = [
    {
        "name": "Testing",
        "coords": [
            [-24.400884,16.651622],[-24.394042,16.652504],[-24.392954,16.645461],
            [-24.400168,16.644662],[-24.400884,16.651622]
        ]
    }
]
# islands = [
#     {
#         "name": "Boa_Vista",
#         "coords": [
#             [-22.8315173, 15.96894709],[-22.86597722,15.96627625],[-22.89098848,15.96787876],
#             [-22.90015926,15.98710783],[-22.93045066,15.99778986],[-22.9557398,16.00793726],
#             [-22.96768962,16.0210213],[-22.97435929,16.04051224],[-22.97074655,16.06053521],
#             [-22.96768962,16.07548438],[-22.96546639,16.08776323],[-22.95296077,16.10110893],
#             [-22.93684243,16.10778144],[-22.92378099,16.12005827],[-22.91655552,16.14194119],
#             [-22.91877875,16.15528324],[-22.93906563,16.16488895],[-22.9460132,16.18143104],
#             [-22.93156227,16.19183584],[-22.92933904,16.21131002],[-22.92794953,16.22864841],
#             [-22.91683342,16.23691696],[-22.90210459,16.23798384],[-22.89293379,16.22731474],
#             [-22.87014578,16.21611157],[-22.84930308,16.21451105],[-22.82623715,16.21557807],
#             [-22.80539444,16.21957929],[-22.80289334,16.23478317],[-22.78983188,16.24065102],
#             [-22.76509855,16.23451644],[-22.75064762,16.22438064],[-22.73175023,16.22064626],
#             [-22.71340864,16.21451105],[-22.69673447,16.20730863],[-22.68561837,16.19797175],
#             [-22.68756372,16.18569974],[-22.68617421,16.17129251],[-22.67005584,16.15581689],
#             [-22.65893973,16.14380912],[-22.66255248,16.12352766],[-22.65921761,16.10110891],
#             [-22.65365956,16.0824247],[-22.67088956,16.0522593],[-22.68700788,16.02929851],
#             [-22.71007381,16.01835116],[-22.74175474,16.00446583],[-22.78056175,15.98008432],
#             [-22.7866756,15.96005328],[-22.79862542,15.9576494],[-22.81279844,15.96806593],
#             [-22.8315173,15.96894709]
#         ]
#     },
#     {
#         "name": "Brava",
#         "coords": [
#             [-24.72104873,14.8054831],[-24.73124915,14.8151711],[-24.73476654,14.8221394],
#             [-24.73775633,14.82655821],[-24.74531871,14.82706806],[-24.75129827,14.83369609],
#             [-24.75059479,14.84372271],[-24.75094654,14.85306915],[-24.75094654,14.86496402],
#             [-24.74953957,14.87125104],[-24.74162545,14.87295021],[-24.73828393,14.88195557],
#             [-24.73599763,14.88926151],[-24.72896286,14.89181004],[-24.7177072,14.89469834],
#             [-24.70979307,14.89537794],[-24.70258244,14.89809629],[-24.69642701,14.89979525],
#             [-24.69167854,14.90302322],[-24.67936768,14.90404257],[-24.67549853,14.90064472],
#             [-24.67092594,14.89486824],[-24.6693431,14.88977122],[-24.67250876,14.88467409],
#             [-24.67268464,14.87872727],[-24.67057421,14.87210063],[-24.66776029,14.86683317],
#             [-24.66477051,14.86309487],[-24.66441875,14.85714747],[-24.66371528,14.85086003],
#             [-24.66054963,14.84508222],[-24.6624842,14.84083374],[-24.66336355,14.83471577],
#             [-24.66512224,14.82723802],[-24.66846375,14.82111967],[-24.67286049,14.81687072],
#             [-24.67971941,14.81211178],[-24.6860507,14.80735276],[-24.69132678,14.80191372],
#             [-24.70311003,14.800214],  [-24.71225526,14.80123383],[-24.72104873,14.8054831]
#         ]
#     },
#     {
#         "name": "Fogo",
#         "coords": [
#             [-24.417223,14.81280296],[-24.43753428,14.82368146],[-24.45980322,14.8392888],
#             [-24.47840145,14.85158469],[-24.48427458,14.8657714],[-24.50899065,14.88161213],
#             [-24.50629881,14.93987161],[-24.50311752,14.96161525],[-24.47762613,15.0006761],
#             [-24.46514574,15.01296277],[-24.44458979,15.0221773],[-24.42917282,15.03257272],
#             [-24.40641444,15.04036895],[-24.39319992,15.04840113],[-24.37215454,15.05572432],
#             [-24.35796114,15.05926771],[-24.34083118,15.05454318],[-24.3210094,15.04792866],
#             [-24.30877372,15.03895148],[-24.29825103,15.02619378],[-24.2904202,15.01012745],
#             [-24.28552592,14.98980653],[-24.27867393,14.96785789],[-24.27818452,14.94422407],
#             [-24.27671622,14.93027889],[-24.27280082,14.91136874],[-24.27206667,14.89576661],
#             [-24.27133253,14.87590772],[-24.27696095,14.8591208],[-24.29874045,14.83429269],
#             [-24.31905168,14.82388768],[-24.34670433,14.81088071],[-24.3697074,14.80591421],
#             [-24.39882834,14.80686023],[-24.417223,14.81280296]
#         ]
#     },
#     {
#         "name": "Maio",
#         "coords": [
#             [-23.17306614,15.11258839],[-23.19287359,15.11603975],[-23.2121308,15.12320782],
#             [-23.21928345,15.13143752],[-23.23496433,15.14046327],[-23.23551453,15.15108131],
#             [-23.23909088,15.15957535],[-23.23771536,15.17178494],[-23.23881578,15.18425924],
#             [-23.23386391,15.19699817],[-23.23496433,15.21000172],[-23.2319382,15.22008556],
#             [-23.22396021,15.22698474],[-23.22093408,15.24263974],[-23.2220345,15.25192605],
#             [-23.23496433,15.25404856],[-23.23606475,15.26413029],[-23.2324884,15.27633384],
#             [-23.22671124,15.28323117],[-23.21708262,15.28508811],[-23.20745401,15.29357675],
#             [-23.20057644,15.30577857],[-23.20745401,15.3137359],[-23.19810053,15.31744922],
#             [-23.19204827,15.31904061],[-23.19204827,15.32752788],[-23.18709641,15.33309746],
#             [-23.18296986,15.34264497],[-23.17444166,15.34131895],[-23.16921472,15.3360148],
#             [-23.1689396,15.3291192],[-23.16096163,15.3360148],[-23.15435917,15.33362789],
#             [-23.15380893,15.3214277],[-23.13235093,15.31638827],[-23.11777047,15.32116246],
#             [-23.10208961,15.31134873],[-23.09796306,15.29410727],[-23.09493691,15.27766026],
#             [-23.09493691,15.2662527],[-23.09053525,15.25059946],[-23.08530831,15.23388369],
#             [-23.08365767,15.21822803],[-23.0828324,15.20655189],[-23.08063157,15.19301734],
#             [-23.07843073,15.17284661],[-23.08200708,15.15984078],[-23.08970997,15.15161219],
#             [-23.09933858,15.14046327],[-23.11116797,15.13117205],[-23.12492312,15.12533163],
#             [-23.13647748,15.11869462],[-23.14913219,15.11019894],[-23.17306614,15.11258839]
#         ]
#     },
#     {
#         "name": "Sal",
#         "coords": [
#             [-22.90891358,16.5886017],[-22.91988386,16.58008001],[-22.93026112,16.58206843],
#             [-22.93470851,16.58945383],[-22.93470851,16.59825916],[-22.93530149,16.61359646],
#             [-22.93826642,16.62467265],[-22.94716121,16.6326244],[-22.95487001,16.64085979],
#             [-22.95546303,16.65590974],[-22.94894015,16.66215656],[-22.94212084,16.67351387],
#             [-22.94271382,16.68316704],[-22.95487001,16.68941297],[-22.96821219,16.69423921],
#             [-22.97770001,16.69083247],[-22.99044917,16.69026466],[-23.0023089,16.70020088],
#             [-22.99519308,16.70701399],[-22.9821474,16.713543],[-22.99015271,16.72262645],
#             [-22.99519308,16.73625084],[-22.98718778,16.74306265],[-22.98629829,16.74987421],
#             [-22.99193164,16.75668558],[-22.99815801,16.77059129],[-22.99756503,16.78392847],
#             [-22.99964048,16.79527853],[-22.99993699,16.80804653],[-22.99697206,16.82052997],
#             [-22.98955973,16.83187784],[-22.97710699,16.83811886],[-22.96584029,16.84180666],
#             [-22.9593174,16.84691272],[-22.94982963,16.85116765],[-22.94360326,16.84804737],
#             [-22.93470847,16.85116765],[-22.92759265,16.85485518],[-22.92284875,16.85967724],
#             [-22.91513995,16.85882629],[-22.90624516,16.85457153],[-22.89675739,16.84804737],
#             [-22.88726958,16.83896991],[-22.8878626,16.83045939],[-22.88815907,16.81854403],
#             [-22.89527493,16.81060003],[-22.89675739,16.80577673],[-22.89053102,16.80066957],
#             [-22.8866766,16.79300857],[-22.88163623,16.78449599],[-22.87659586,16.77740189],
#             [-22.8742239,16.77059129],[-22.88045027,16.76151011],[-22.8866766,16.75441515],
#             [-22.89171697,16.75725317],[-22.89527493,16.75100948],[-22.88993804,16.74306265],
#             [-22.89023451,16.73398018],[-22.89438544,16.73170948],[-22.89053102,16.72603264],
#             [-22.88726958,16.71808478],[-22.88282218,16.70900112],[-22.87689232,16.70218807],
#             [-22.87066599,16.70105254],[-22.87214846,16.69054857],[-22.87540986,16.68487051],
#             [-22.87155548,16.67862443],[-22.86710809,16.67124246],[-22.86947999,16.66527989],
#             [-22.87659586,16.66102079],[-22.88045027,16.65307022],[-22.88133972,16.6436995],
#             [-22.88697311,16.63660016],[-22.89468191,16.63631616],[-22.89527493,16.62666063],
#             [-22.89231,16.61615256],[-22.88697311,16.60791613],[-22.88104325,16.59825916],
#             [-22.87985725,16.58774956],[-22.88993804,16.58576117],[-22.89853632,16.59059005],
#             [-22.90802409,16.5928624],[-22.90891358,16.5886017]
#         ]
#     },
#     {
#         "name": "Santiago",
#         "coords": [
#             [-23.53907955,14.89451334],[-23.55985007,14.89738095],[-23.56637794,14.90254257],
#             [-23.58299437,14.90168231],[-23.59456652,14.90311607],[-23.60495178,14.90770405],
#             [-23.61533705,14.90856429],[-23.62750264,14.90483657],[-23.63699774,14.91257868],
#             [-23.65331743,14.92318777],[-23.66429614,14.93064249],[-23.68150601,14.93580331],
#             [-23.69990276,14.94698465],[-23.70821097,14.95873876],[-23.71859623,14.9747921],
#             [-23.73254216,14.98281834],[-23.73550938,14.9937106],[-23.726311,15.00230935],
#             [-23.7248274,15.01320062],[-23.73758643,15.02409131],[-23.74530119,15.02896331],
#             [-23.75242252,15.02724378],[-23.77319305,15.05418116],[-23.7847652,15.05905246],
#             [-23.78654553,15.08140165],[-23.77972093,15.10632684],[-23.77319305,15.13210841],
#             [-23.77230288,15.16246938],[-23.77645698,15.18165755],[-23.76458811,15.20313477],
#             [-23.76280778,15.22890455],[-23.74975202,15.2443649],[-23.76429139,15.25753394],
#             [-23.76579522,15.28338832],[-23.78122474,15.29312022],[-23.76905915,15.3288954],
#             [-23.74888207,15.34549301],[-23.73078204,15.34520685],[-23.70407709,15.33891135],
#             [-23.68479017,15.33290184],[-23.67707539,15.31458606],[-23.6812295,15.29455135],
#             [-23.68479017,15.2756597],[-23.6729213,15.2619193],[-23.64502945,15.25275851],
#             [-23.62307203,15.24130696],[-23.60052118,15.22011995],[-23.55452931,15.16284712],
#             [-23.53049484,15.15711898],[-23.5123948,15.14279795],[-23.49637185,15.1281895],
#             [-23.49310791,15.11902291],[-23.48776692,15.10097502],[-23.46669967,15.07261093],
#             [-23.45156685,15.06000348],[-23.43138976,15.03822516],[-23.42871927,15.02561565],
#             [-23.42426844,15.00498032],[-23.42397171,14.98434299],[-23.43376354,14.97402356],
#             [-23.44770946,14.97201696],[-23.45067667,14.95653676],[-23.46402915,14.937615],
#             [-23.47055704,14.91668444],[-23.4741177,14.90091352],[-23.49755871,14.89689891],
#             [-23.53907955,14.89451334]
#         ]
#     },
#     {
#         "name": "Santo_Antao",
#         "coords": [
#             [-25.26142493,16.91430934],[-25.27616875,16.9097265],[-25.29164976,16.90091301],
#             [-25.30307622,16.90020789],[-25.31597707,16.9121942],[-25.32777214,16.92981972],
#             [-25.32629775,16.94603373],[-25.31745145,16.95695978],[-25.32814073,16.97281904],
#             [-25.3303523,16.98797221],[-25.3314581,17.00453356],[-25.33735562,17.01263753],
#             [-25.35025647,17.01510387],[-25.36168293,17.02990132],[-25.37237221,17.04751579],
#             [-25.36758046,17.06618528],[-25.36020854,17.08133091],[-25.34951929,17.09260123],
#             [-25.33698706,17.10140571],[-25.30749941,17.10985763],[-25.28943822,17.12253477],
#             [-25.26805966,17.1267603],[-25.2477869,17.13626738],[-25.23193727,17.14894272],
#             [-25.21350749,17.15985692],[-25.1983951,17.17006638],[-25.18033388,17.18203539],
#             [-25.15563799,17.19259563],[-25.12836193,17.20245131],[-25.10587757,17.2101947],
#             [-25.09150237,17.21441822],[-25.06828083,17.20737896],[-25.05279982,17.19153963],
#             [-25.03510722,17.1883716],[-25.00672537,17.18168335],[-24.99898484,17.16584184],
#             [-24.99603606,17.14929481],[-24.98608399,17.13626738],[-24.97539474,17.13345052],
#             [-24.95770214,17.12112625],[-24.953279,17.10598387],[-24.95512198,17.08872713],
#             [-24.96323107,17.07287768],[-24.97502612,17.05702689],[-24.98976995,17.04117476],
#             [-25.0122543,17.03095825],[-25.03068408,17.01721788],[-25.05021961,17.00629535],
#             [-25.07122961,17.00594297],[-25.09076513,16.99431504],[-25.1040346,16.97951478],
#             [-25.11472385,16.9604842],[-25.12578177,16.95132061],[-25.1405256,16.94779604],
#             [-25.15121485,16.93581201],[-25.1641157,16.91959711],[-25.18586288,16.90655369],
#             [-25.20502984,16.89915026],[-25.22382824,16.90232317],[-25.2488927,16.90866889],
#             [-25.26142493,16.91430934]
#         ]
#     },
#     {
#         "name": "Sao_Nicolau",
#         "coords": [
#             [-24.31466793,16.47636763],[-24.32707974,16.47891714],[-24.33402444,16.48557407],
#             [-24.33535429,16.50610994],[-24.33727517,16.5195633],[-24.34658402,16.52706844],
#             [-24.35308546,16.54604242],[-24.36268984,16.55043165],[-24.36461072,16.56274931],
#             [-24.36623607,16.57464146],[-24.3818986,16.57648185],[-24.39357162,16.5804457],
#             [-24.40716551,16.58950562],[-24.42016837,16.59573407],[-24.42563547,16.60436862],
#             [-24.42992051,16.61342742],[-24.4307613,16.63491685],[-24.42972697,16.65048391],
#             [-24.42027035,16.65939902],[-24.40667646,16.66520069],[-24.39884519,16.66774771],
#             [-24.39116169,16.67086069],[-24.38466026,16.67340764],[-24.37786332,16.67581305],
#             [-24.37180517,16.67666202],[-24.36486047,16.67652052],[-24.35791575,16.67736949],
#             [-24.35215313,16.68218019],[-24.34831137,16.68373657],[-24.34092338,16.68656632],
#             [-24.33294434,16.68401954],[-24.32732949,16.68147275],[-24.31550871,16.67595455],
#             [-24.30634759,16.6698702],[-24.29999394,16.66364416],[-24.29452682,16.65954052],
#             [-24.28846868,16.65104996],[-24.28196724,16.64793666],[-24.2810807,16.6417099],
#             [-24.27561359,16.63944557],[-24.26497488,16.6417099],[-24.25743914,16.64227598],
#             [-24.24872131,16.64227598],[-24.24192437,16.64411572],[-24.2355707,16.6473706],
#             [-24.22670512,16.64991786],[-24.21724851,16.64906878],[-24.20823516,16.64765363],
#             [-24.20173374,16.64411572],[-24.19464127,16.64312509],[-24.17528471,16.63364312],
#             [-24.17040866,16.63052954],[-24.16109979,16.62147155],[-24.14750591,16.61566855],
#             [-24.13893584,16.6169424],[-24.13391199,16.62161308],[-24.1294792,16.62486834],
#             [-24.11278237,16.61920699],[-24.1017004,16.61920699],[-24.08899305,16.61807469],
#             [-24.07643348,16.61623471],[-24.06224854,16.61269622],[-24.04333531,16.60491131],
#             [-24.03624284,16.59939091],[-24.03299213,16.59316258],[-24.03195782,16.58820808],
#             [-24.02013704,16.58834964],[-24.01378337,16.58325346],[-24.00639538,16.57659991],
#             [-24.00270139,16.57065398],[-24.00609987,16.56215948],[-24.01023712,16.55323986],
#             [-24.01718185,16.54701004],[-24.02752503,16.54446141],[-24.04200546,16.54870909],
#             [-24.05160984,16.55394778],[-24.06121422,16.54870909],[-24.0745126,16.54658526],
#             [-24.08692443,16.54771798],[-24.09785863,16.54870909],[-24.10953165,16.54785957],
#             [-24.12090916,16.55309827],[-24.13021801,16.56668993],[-24.15181922,16.5740104],
#             [-24.16733399,16.58321218],[-24.17014141,16.58816681],[-24.18875915,16.58816681],
#             [-24.20043217,16.58689277],[-24.2116619,16.58929927],[-24.22363044,16.58944084],
#             [-24.23648553,16.58745902],[-24.24402128,16.57726646],[-24.25672861,16.57726646],
#             [-24.26308227,16.57245313],[-24.27150458,16.56126873],[-24.27593737,16.55985294],
#             [-24.28037017,16.55093321],[-24.27918808,16.54201306],[-24.28509847,16.53691565],
#             [-24.28775815,16.5302605],[-24.29012229,16.52162262],[-24.29292974,16.51482532],
#             [-24.29736253,16.50788617],[-24.30076099,16.50335434],[-24.30223858,16.49627316],
#             [-24.30149979,16.48905008],[-24.30061324,16.48281818],[-24.31466793,16.47636763]
#         ]
#     },
#     {
#         "name": "Sao_Vicente",
#         "coords": [
#             [-24.98140083,16.77300407],[-24.99467744,16.77512192],[-25.00574131,16.78340057],
#             [-25.02183419,16.79033125],[-25.03631777,16.79610662],[-25.04637582,16.80014928],
#             [-25.0542211,16.79918675],[-25.06488264,16.80784934],[-25.06689425,16.82036128],
#             [-25.0769523,16.82498086],[-25.08902195,16.8236335],[-25.09002776,16.83383475],
#             [-25.08580338,16.83903141],[-25.08962543,16.84442037],[-25.08137783,16.85192618],
#             [-25.07654996,16.86039392],[-25.06830237,16.8684764],[-25.06025593,16.87501913],
#             [-25.0568362,16.88464035],[-25.05039904,16.88829628],[-25.03832938,16.89022043],
#             [-25.0284725,16.89195215],[-25.02102954,16.88906595],[-25.01600052,16.88290856],
#             [-25.00755176,16.88040707],[-25.0011146,16.88387067],[-25.00714943,16.89022043],
#             [-25.00413201,16.89733961],[-25.00554015,16.90599771],[-25.00091344,16.91350108],
#             [-24.98703335,16.91696406],[-24.97013581,16.92273557],[-24.96027893,16.92850691],
#             [-24.9558534,16.92485175],[-24.95766383,16.91504019],[-24.9470023,16.91176955],
#             [-24.93372569,16.92619839],[-24.92004674,16.92850691],[-24.90556315,16.92312033],
#             [-24.89952833,16.91388585],[-24.89731554,16.90522811],[-24.90616661,16.89368385],
#             [-24.90797708,16.88521761],[-24.89751672,16.87444183],[-24.88725749,16.87059319],
#             [-24.87639481,16.86597473],[-24.86593442,16.86963102],[-24.85849147,16.86578228],
#             [-24.85265781,16.85789213],[-24.85627872,16.84903937],[-24.86110657,16.8471148],
#             [-24.85909496,16.84172591],[-24.85245664,16.83672179],[-24.8532613,16.82555831],
#             [-24.85567523,16.81689652],[-24.86030194,16.81015931],[-24.86915301,16.80476936],
#             [-24.88222847,16.80438436],[-24.89389581,16.80399935],[-24.90174108,16.8009193],
#             [-24.90656896,16.79495157],[-24.9146154,16.7909088],[-24.92748972,16.78782853],
#             [-24.93654196,16.78378561],[-24.94921511,16.78359309],[-24.95866967,16.77993513],
#             [-24.96671611,16.77935756],[-24.97214745,16.77184887],[-24.98140083,16.77300407]
#         ]
#     }
# ]

# islands = [
#     {
#         "name": "Boa_Vista",
#         "coords": [
#             [-22.8315173, 15.96894709],[-22.86597722,15.96627625],[-22.89098848,15.96787876],
#             [-22.90015926,15.98710783],[-22.93045066,15.99778986],[-22.9557398,16.00793726],
#             [-22.96768962,16.0210213],[-22.97435929,16.04051224],[-22.97074655,16.06053521],
#             [-22.96768962,16.07548438],[-22.96546639,16.08776323],[-22.95296077,16.10110893],
#             [-22.93684243,16.10778144],[-22.92378099,16.12005827],[-22.91655552,16.14194119],
#             [-22.91877875,16.15528324],[-22.93906563,16.16488895],[-22.9460132,16.18143104],
#             [-22.93156227,16.19183584],[-22.92933904,16.21131002],[-22.92794953,16.22864841],
#             [-22.91683342,16.23691696],[-22.90210459,16.23798384],[-22.89293379,16.22731474],
#             [-22.87014578,16.21611157],[-22.84930308,16.21451105],[-22.82623715,16.21557807],
#             [-22.80539444,16.21957929],[-22.80289334,16.23478317],[-22.78983188,16.24065102],
#             [-22.76509855,16.23451644],[-22.75064762,16.22438064],[-22.73175023,16.22064626],
#             [-22.71340864,16.21451105],[-22.69673447,16.20730863],[-22.68561837,16.19797175],
#             [-22.68756372,16.18569974],[-22.68617421,16.17129251],[-22.67005584,16.15581689],
#             [-22.65893973,16.14380912],[-22.66255248,16.12352766],[-22.65921761,16.10110891],
#             [-22.65365956,16.0824247],[-22.67088956,16.0522593],[-22.68700788,16.02929851],
#             [-22.71007381,16.01835116],[-22.74175474,16.00446583],[-22.78056175,15.98008432],
#             [-22.7866756,15.96005328],[-22.79862542,15.9576494],[-22.81279844,15.96806593],
#             [-22.8315173,15.96894709]
#         ]
#     },
#     {
#         "name": "Brava",
#         "coords": [
#             [-24.72104873,14.8054831],[-24.73124915,14.8151711],[-24.73476654,14.8221394],
#             [-24.73775633,14.82655821],[-24.74531871,14.82706806],[-24.75129827,14.83369609],
#             [-24.75059479,14.84372271],[-24.75094654,14.85306915],[-24.75094654,14.86496402],
#             [-24.74953957,14.87125104],[-24.74162545,14.87295021],[-24.73828393,14.88195557],
#             [-24.73599763,14.88926151],[-24.72896286,14.89181004],[-24.7177072,14.89469834],
#             [-24.70979307,14.89537794],[-24.70258244,14.89809629],[-24.69642701,14.89979525],
#             [-24.69167854,14.90302322],[-24.67936768,14.90404257],[-24.67549853,14.90064472],
#             [-24.67092594,14.89486824],[-24.6693431,14.88977122],[-24.67250876,14.88467409],
#             [-24.67268464,14.87872727],[-24.67057421,14.87210063],[-24.66776029,14.86683317],
#             [-24.66477051,14.86309487],[-24.66441875,14.85714747],[-24.66371528,14.85086003],
#             [-24.66054963,14.84508222],[-24.6624842,14.84083374],[-24.66336355,14.83471577],
#             [-24.66512224,14.82723802],[-24.66846375,14.82111967],[-24.67286049,14.81687072],
#             [-24.67971941,14.81211178],[-24.6860507,14.80735276],[-24.69132678,14.80191372],
#             [-24.70311003,14.800214],  [-24.71225526,14.80123383],[-24.72104873,14.8054831]
#         ]
#     },
#     {
#         "name": "Fogo",
#         "coords": [
#             [-24.417223,14.81280296],[-24.43753428,14.82368146],[-24.45980322,14.8392888],
#             [-24.47840145,14.85158469],[-24.48427458,14.8657714],[-24.50899065,14.88161213],
#             [-24.50629881,14.93987161],[-24.50311752,14.96161525],[-24.47762613,15.0006761],
#             [-24.46514574,15.01296277],[-24.44458979,15.0221773],[-24.42917282,15.03257272],
#             [-24.40641444,15.04036895],[-24.39319992,15.04840113],[-24.37215454,15.05572432],
#             [-24.35796114,15.05926771],[-24.34083118,15.05454318],[-24.3210094,15.04792866],
#             [-24.30877372,15.03895148],[-24.29825103,15.02619378],[-24.2904202,15.01012745],
#             [-24.28552592,14.98980653],[-24.27867393,14.96785789],[-24.27818452,14.94422407],
#             [-24.27671622,14.93027889],[-24.27280082,14.91136874],[-24.27206667,14.89576661],
#             [-24.27133253,14.87590772],[-24.27696095,14.8591208],[-24.29874045,14.83429269],
#             [-24.31905168,14.82388768],[-24.34670433,14.81088071],[-24.3697074,14.80591421],
#             [-24.39882834,14.80686023],[-24.417223,14.81280296]
#         ]
#     },
#     {
#         "name": "Maio",
#         "coords": [
#             [-23.17306614,15.11258839],[-23.19287359,15.11603975],[-23.2121308,15.12320782],
#             [-23.21928345,15.13143752],[-23.23496433,15.14046327],[-23.23551453,15.15108131],
#             [-23.23909088,15.15957535],[-23.23771536,15.17178494],[-23.23881578,15.18425924],
#             [-23.23386391,15.19699817],[-23.23496433,15.21000172],[-23.2319382,15.22008556],
#             [-23.22396021,15.22698474],[-23.22093408,15.24263974],[-23.2220345,15.25192605],
#             [-23.23496433,15.25404856],[-23.23606475,15.26413029],[-23.2324884,15.27633384],
#             [-23.22671124,15.28323117],[-23.21708262,15.28508811],[-23.20745401,15.29357675],
#             [-23.20057644,15.30577857],[-23.20745401,15.3137359],[-23.19810053,15.31744922],
#             [-23.19204827,15.31904061],[-23.19204827,15.32752788],[-23.18709641,15.33309746],
#             [-23.18296986,15.34264497],[-23.17444166,15.34131895],[-23.16921472,15.3360148],
#             [-23.1689396,15.3291192],[-23.16096163,15.3360148],[-23.15435917,15.33362789],
#             [-23.15380893,15.3214277],[-23.13235093,15.31638827],[-23.11777047,15.32116246],
#             [-23.10208961,15.31134873],[-23.09796306,15.29410727],[-23.09493691,15.27766026],
#             [-23.09493691,15.2662527],[-23.09053525,15.25059946],[-23.08530831,15.23388369],
#             [-23.08365767,15.21822803],[-23.0828324,15.20655189],[-23.08063157,15.19301734],
#             [-23.07843073,15.17284661],[-23.08200708,15.15984078],[-23.08970997,15.15161219],
#             [-23.09933858,15.14046327],[-23.11116797,15.13117205],[-23.12492312,15.12533163],
#             [-23.13647748,15.11869462],[-23.14913219,15.11019894],[-23.17306614,15.11258839]
#         ]
#     },
#     {
#         "name": "Sal",
#         "coords": [
#             [-22.90891358,16.5886017],[-22.91988386,16.58008001],[-22.93026112,16.58206843],
#             [-22.93470851,16.58945383],[-22.93470851,16.59825916],[-22.93530149,16.61359646],
#             [-22.93826642,16.62467265],[-22.94716121,16.6326244],[-22.95487001,16.64085979],
#             [-22.95546303,16.65590974],[-22.94894015,16.66215656],[-22.94212084,16.67351387],
#             [-22.94271382,16.68316704],[-22.95487001,16.68941297],[-22.96821219,16.69423921],
#             [-22.97770001,16.69083247],[-22.99044917,16.69026466],[-23.0023089,16.70020088],
#             [-22.99519308,16.70701399],[-22.9821474,16.713543],[-22.99015271,16.72262645],
#             [-22.99519308,16.73625084],[-22.98718778,16.74306265],[-22.98629829,16.74987421],
#             [-22.99193164,16.75668558],[-22.99815801,16.77059129],[-22.99756503,16.78392847],
#             [-22.99964048,16.79527853],[-22.99993699,16.80804653],[-22.99697206,16.82052997],
#             [-22.98955973,16.83187784],[-22.97710699,16.83811886],[-22.96584029,16.84180666],
#             [-22.9593174,16.84691272],[-22.94982963,16.85116765],[-22.94360326,16.84804737],
#             [-22.93470847,16.85116765],[-22.92759265,16.85485518],[-22.92284875,16.85967724],
#             [-22.91513995,16.85882629],[-22.90624516,16.85457153],[-22.89675739,16.84804737],
#             [-22.88726958,16.83896991],[-22.8878626,16.83045939],[-22.88815907,16.81854403],
#             [-22.89527493,16.81060003],[-22.89675739,16.80577673],[-22.89053102,16.80066957],
#             [-22.8866766,16.79300857],[-22.88163623,16.78449599],[-22.87659586,16.77740189],
#             [-22.8742239,16.77059129],[-22.88045027,16.76151011],[-22.8866766,16.75441515],
#             [-22.89171697,16.75725317],[-22.89527493,16.75100948],[-22.88993804,16.74306265],
#             [-22.89023451,16.73398018],[-22.89438544,16.73170948],[-22.89053102,16.72603264],
#             [-22.88726958,16.71808478],[-22.88282218,16.70900112],[-22.87689232,16.70218807],
#             [-22.87066599,16.70105254],[-22.87214846,16.69054857],[-22.87540986,16.68487051],
#             [-22.87155548,16.67862443],[-22.86710809,16.67124246],[-22.86947999,16.66527989],
#             [-22.87659586,16.66102079],[-22.88045027,16.65307022],[-22.88133972,16.6436995],
#             [-22.88697311,16.63660016],[-22.89468191,16.63631616],[-22.89527493,16.62666063],
#             [-22.89231,16.61615256],[-22.88697311,16.60791613],[-22.88104325,16.59825916],
#             [-22.87985725,16.58774956],[-22.88993804,16.58576117],[-22.89853632,16.59059005],
#             [-22.90802409,16.5928624],[-22.90891358,16.5886017]
#         ]
#     },
#     {
#         "name": "Santiago",
#         "coords": [
#             [-23.53907955,14.89451334],[-23.55985007,14.89738095],[-23.56637794,14.90254257],
#             [-23.58299437,14.90168231],[-23.59456652,14.90311607],[-23.60495178,14.90770405],
#             [-23.61533705,14.90856429],[-23.62750264,14.90483657],[-23.63699774,14.91257868],
#             [-23.65331743,14.92318777],[-23.66429614,14.93064249],[-23.68150601,14.93580331],
#             [-23.69990276,14.94698465],[-23.70821097,14.95873876],[-23.71859623,14.9747921],
#             [-23.73254216,14.98281834],[-23.73550938,14.9937106],[-23.726311,15.00230935],
#             [-23.7248274,15.01320062],[-23.73758643,15.02409131],[-23.74530119,15.02896331],
#             [-23.75242252,15.02724378],[-23.77319305,15.05418116],[-23.7847652,15.05905246],
#             [-23.78654553,15.08140165],[-23.77972093,15.10632684],[-23.77319305,15.13210841],
#             [-23.77230288,15.16246938],[-23.77645698,15.18165755],[-23.76458811,15.20313477],
#             [-23.76280778,15.22890455],[-23.74975202,15.2443649],[-23.76429139,15.25753394],
#             [-23.76579522,15.28338832],[-23.78122474,15.29312022],[-23.76905915,15.3288954],
#             [-23.74888207,15.34549301],[-23.73078204,15.34520685],[-23.70407709,15.33891135],
#             [-23.68479017,15.33290184],[-23.67707539,15.31458606],[-23.6812295,15.29455135],
#             [-23.68479017,15.2756597],[-23.6729213,15.2619193],[-23.64502945,15.25275851],
#             [-23.62307203,15.24130696],[-23.60052118,15.22011995],[-23.55452931,15.16284712],
#             [-23.53049484,15.15711898],[-23.5123948,15.14279795],[-23.49637185,15.1281895],
#             [-23.49310791,15.11902291],[-23.48776692,15.10097502],[-23.46669967,15.07261093],
#             [-23.45156685,15.06000348],[-23.43138976,15.03822516],[-23.42871927,15.02561565],
#             [-23.42426844,15.00498032],[-23.42397171,14.98434299],[-23.43376354,14.97402356],
#             [-23.44770946,14.97201696],[-23.45067667,14.95653676],[-23.46402915,14.937615],
#             [-23.47055704,14.91668444],[-23.4741177,14.90091352],[-23.49755871,14.89689891],
#             [-23.53907955,14.89451334]
#         ]
#     },
#     {
#         "name": "Santo_Antao",
#         "coords": [
#             [-25.26142493,16.91430934],[-25.27616875,16.9097265],[-25.29164976,16.90091301],
#             [-25.30307622,16.90020789],[-25.31597707,16.9121942],[-25.32777214,16.92981972],
#             [-25.32629775,16.94603373],[-25.31745145,16.95695978],[-25.32814073,16.97281904],
#             [-25.3303523,16.98797221],[-25.3314581,17.00453356],[-25.33735562,17.01263753],
#             [-25.35025647,17.01510387],[-25.36168293,17.02990132],[-25.37237221,17.04751579],
#             [-25.36758046,17.06618528],[-25.36020854,17.08133091],[-25.34951929,17.09260123],
#             [-25.33698706,17.10140571],[-25.30749941,17.10985763],[-25.28943822,17.12253477],
#             [-25.26805966,17.1267603],[-25.2477869,17.13626738],[-25.23193727,17.14894272],
#             [-25.21350749,17.15985692],[-25.1983951,17.17006638],[-25.18033388,17.18203539],
#             [-25.15563799,17.19259563],[-25.12836193,17.20245131],[-25.10587757,17.2101947],
#             [-25.09150237,17.21441822],[-25.06828083,17.20737896],[-25.05279982,17.19153963],
#             [-25.03510722,17.1883716],[-25.00672537,17.18168335],[-24.99898484,17.16584184],
#             [-24.99603606,17.14929481],[-24.98608399,17.13626738],[-24.97539474,17.13345052],
#             [-24.95770214,17.12112625],[-24.953279,17.10598387],[-24.95512198,17.08872713],
#             [-24.96323107,17.07287768],[-24.97502612,17.05702689],[-24.98976995,17.04117476],
#             [-25.0122543,17.03095825],[-25.03068408,17.01721788],[-25.05021961,17.00629535],
#             [-25.07122961,17.00594297],[-25.09076513,16.99431504],[-25.1040346,16.97951478],
#             [-25.11472385,16.9604842],[-25.12578177,16.95132061],[-25.1405256,16.94779604],
#             [-25.15121485,16.93581201],[-25.1641157,16.91959711],[-25.18586288,16.90655369],
#             [-25.20502984,16.89915026],[-25.22382824,16.90232317],[-25.2488927,16.90866889],
#             [-25.26142493,16.91430934]
#         ]
#     },
#     {
#         "name": "Sao_Nicolau",
#         "coords": [
#             [-24.31466793,16.47636763],[-24.32707974,16.47891714],[-24.33402444,16.48557407],
#             [-24.33535429,16.50610994],[-24.33727517,16.5195633],[-24.34658402,16.52706844],
#             [-24.35308546,16.54604242],[-24.36268984,16.55043165],[-24.36461072,16.56274931],
#             [-24.36623607,16.57464146],[-24.3818986,16.57648185],[-24.39357162,16.5804457],
#             [-24.40716551,16.58950562],[-24.42016837,16.59573407],[-24.42563547,16.60436862],
#             [-24.42992051,16.61342742],[-24.4307613,16.63491685],[-24.42972697,16.65048391],
#             [-24.42027035,16.65939902],[-24.40667646,16.66520069],[-24.39884519,16.66774771],
#             [-24.39116169,16.67086069],[-24.38466026,16.67340764],[-24.37786332,16.67581305],
#             [-24.37180517,16.67666202],[-24.36486047,16.67652052],[-24.35791575,16.67736949],
#             [-24.35215313,16.68218019],[-24.34831137,16.68373657],[-24.34092338,16.68656632],
#             [-24.33294434,16.68401954],[-24.32732949,16.68147275],[-24.31550871,16.67595455],
#             [-24.30634759,16.6698702],[-24.29999394,16.66364416],[-24.29452682,16.65954052],
#             [-24.28846868,16.65104996],[-24.28196724,16.64793666],[-24.2810807,16.6417099],
#             [-24.27561359,16.63944557],[-24.26497488,16.6417099],[-24.25743914,16.64227598],
#             [-24.24872131,16.64227598],[-24.24192437,16.64411572],[-24.2355707,16.6473706],
#             [-24.22670512,16.64991786],[-24.21724851,16.64906878],[-24.20823516,16.64765363],
#             [-24.20173374,16.64411572],[-24.19464127,16.64312509],[-24.17528471,16.63364312],
#             [-24.17040866,16.63052954],[-24.16109979,16.62147155],[-24.14750591,16.61566855],
#             [-24.13893584,16.6169424],[-24.13391199,16.62161308],[-24.1294792,16.62486834],
#             [-24.11278237,16.61920699],[-24.1017004,16.61920699],[-24.08899305,16.61807469],
#             [-24.07643348,16.61623471],[-24.06224854,16.61269622],[-24.04333531,16.60491131],
#             [-24.03624284,16.59939091],[-24.03299213,16.59316258],[-24.03195782,16.58820808],
#             [-24.02013704,16.58834964],[-24.01378337,16.58325346],[-24.00639538,16.57659991],
#             [-24.00270139,16.57065398],[-24.00609987,16.56215948],[-24.01023712,16.55323986],
#             [-24.01718185,16.54701004],[-24.02752503,16.54446141],[-24.04200546,16.54870909],
#             [-24.05160984,16.55394778],[-24.06121422,16.54870909],[-24.0745126,16.54658526],
#             [-24.08692443,16.54771798],[-24.09785863,16.54870909],[-24.10953165,16.54785957],
#             [-24.12090916,16.55309827],[-24.13021801,16.56668993],[-24.15181922,16.5740104],
#             [-24.16733399,16.58321218],[-24.17014141,16.58816681],[-24.18875915,16.58816681],
#             [-24.20043217,16.58689277],[-24.2116619,16.58929927],[-24.22363044,16.58944084],
#             [-24.23648553,16.58745902],[-24.24402128,16.57726646],[-24.25672861,16.57726646],
#             [-24.26308227,16.57245313],[-24.27150458,16.56126873],[-24.27593737,16.55985294],
#             [-24.28037017,16.55093321],[-24.27918808,16.54201306],[-24.28509847,16.53691565],
#             [-24.28775815,16.5302605],[-24.29012229,16.52162262],[-24.29292974,16.51482532],
#             [-24.29736253,16.50788617],[-24.30076099,16.50335434],[-24.30223858,16.49627316],
#             [-24.30149979,16.48905008],[-24.30061324,16.48281818],[-24.31466793,16.47636763]
#         ]
#     },
#     {
#         "name": "Sao_Vicente",
#         "coords": [
#             [-24.98140083,16.77300407],[-24.99467744,16.77512192],[-25.00574131,16.78340057],
#             [-25.02183419,16.79033125],[-25.03631777,16.79610662],[-25.04637582,16.80014928],
#             [-25.0542211,16.79918675],[-25.06488264,16.80784934],[-25.06689425,16.82036128],
#             [-25.0769523,16.82498086],[-25.08902195,16.8236335],[-25.09002776,16.83383475],
#             [-25.08580338,16.83903141],[-25.08962543,16.84442037],[-25.08137783,16.85192618],
#             [-25.07654996,16.86039392],[-25.06830237,16.8684764],[-25.06025593,16.87501913],
#             [-25.0568362,16.88464035],[-25.05039904,16.88829628],[-25.03832938,16.89022043],
#             [-25.0284725,16.89195215],[-25.02102954,16.88906595],[-25.01600052,16.88290856],
#             [-25.00755176,16.88040707],[-25.0011146,16.88387067],[-25.00714943,16.89022043],
#             [-25.00413201,16.89733961],[-25.00554015,16.90599771],[-25.00091344,16.91350108],
#             [-24.98703335,16.91696406],[-24.97013581,16.92273557],[-24.96027893,16.92850691],
#             [-24.9558534,16.92485175],[-24.95766383,16.91504019],[-24.9470023,16.91176955],
#             [-24.93372569,16.92619839],[-24.92004674,16.92850691],[-24.90556315,16.92312033],
#             [-24.89952833,16.91388585],[-24.89731554,16.90522811],[-24.90616661,16.89368385],
#             [-24.90797708,16.88521761],[-24.89751672,16.87444183],[-24.88725749,16.87059319],
#             [-24.87639481,16.86597473],[-24.86593442,16.86963102],[-24.85849147,16.86578228],
#             [-24.85265781,16.85789213],[-24.85627872,16.84903937],[-24.86110657,16.8471148],
#             [-24.85909496,16.84172591],[-24.85245664,16.83672179],[-24.8532613,16.82555831],
#             [-24.85567523,16.81689652],[-24.86030194,16.81015931],[-24.86915301,16.80476936],
#             [-24.88222847,16.80438436],[-24.89389581,16.80399935],[-24.90174108,16.8009193],
#             [-24.90656896,16.79495157],[-24.9146154,16.7909088],[-24.92748972,16.78782853],
#             [-24.93654196,16.78378561],[-24.94921511,16.78359309],[-24.95866967,16.77993513],
#             [-24.96671611,16.77935756],[-24.97214745,16.77184887],[-24.98140083,16.77300407]
#         ]
#     }
# ]

# ---------------------------------------------------------------------------
# 2) PIXEL-WISE CLOUD MASK (QA60 bits 10=cloud, 11=cirrus)
# ---------------------------------------------------------------------------
def mask_clouds(img):
    qa     = img.select("QA60")
    cloud  = 1 << 10
    cirrus = 1 << 11
    keep   = qa.bitwiseAnd(cloud).eq(0).And(qa.bitwiseAnd(cirrus).eq(0))
    return img.updateMask(keep)

# ---------------------------------------------------------------------------
# 3) TILE BBOX INTO â‰¤0.05Â° CHUNKS
# ---------------------------------------------------------------------------
def tile_bbox(coords):
    xs, ys = [c[0] for c in coords], [c[1] for c in coords]
    minx, maxx, miny, maxy = min(xs), max(xs), min(ys), max(ys)
    cols = max(1, math.ceil((maxx - minx) / MAX_TILE_SIZE))
    rows = max(1, math.ceil((maxy - miny) / MAX_TILE_SIZE))
    dx, dy = (maxx - minx) / cols, (maxy - miny) / rows

    tiles = []
    for i in range(cols):
        for j in range(rows):
            x0, y0 = minx + i * dx, miny + j * dy
            tiles.append([
                [x0,     y0],
                [x0,     y0 + dy],
                [x0 + dx,y0 + dy],
                [x0 + dx,y0],
                [x0,     y0]
            ])
    return tiles

# ---------------------------------------------------------------------------
# 4) EXPORT ONE FULL-YEAR STACKED IMAGE PER TILE (all Float64)
# ---------------------------------------------------------------------------
def export_full_year(island, tile_coords, tile_idx):
    ee_tile = ee.Geometry.Polygon(tile_coords)

    # Elevation + terrain
    dem     = ee.Image("USGS/SRTMGL1_003").clip(ee_tile)
    elev    = dem.rename("ELEVATION")
    terrain = ee.Terrain.slope(dem).rename("SLOPE")\
              .addBands(ee.Terrain.aspect(dem).rename("ASPECT"))

    # Build per-season composites + indices
    season_imgs = []
    for sidx, (start, end) in enumerate(TIMESTAMPS):
        col = (ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
               .filterBounds(ee_tile)
               .filterDate(start, end)
               .filter(ee.Filter.lt("CLOUDY_PIXEL_PERCENTAGE", CLOUDY_PIXEL_PERCENTAGE))
               .map(mask_clouds)
               .select(BANDS))

        med = col.median().rename([f"{b}_s{sidx+1}" for b in BANDS])

        # aliases
        nir   = med.select(f"B8_s{sidx+1}")
        red   = med.select(f"B4_s{sidx+1}")
        blue  = med.select(f"B2_s{sidx+1}")
        swir1 = med.select(f"B11_s{sidx+1}")
        swir2 = med.select(f"B12_s{sidx+1}")

        # indices
        ndvi = nir.subtract(red).divide(nir.add(red))\
                   .rename(f"NDVI_s{sidx+1}")
        evi  = med.expression(
                   "2.5*((NIR-RED)/(NIR+6*RED-7.5*BLUE+1))",
                   {'NIR':nir,'RED':red,'BLUE':blue}
               ).rename(f"EVI_s{sidx+1}")
        evi2 = med.expression(
                   "2.5*((NIR-RED)/(NIR+2.4*RED+1))",
                   {'NIR':nir,'RED':red}
               ).rename(f"EVI2_s{sidx+1}")
        nbr  = nir.subtract(swir2).divide(nir.add(swir2))\
                   .rename(f"NBR_s{sidx+1}")
        ndmi = nir.subtract(swir1).divide(nir.add(swir1))\
                   .rename(f"NDMI_s{sidx+1}")

        season_imgs.append(med.addBands([ndvi, evi, evi2, nbr, ndmi]))

    # stack all â†’ Float64
    full = ee.Image.cat(season_imgs).addBands(elev).addBands(terrain).toDouble()

    desc = f"{island['name']}_tile{tile_idx}"
    task = ee.batch.Export.image.toDrive(
        image=full,
        description=desc,
        folder="PythonProject_fullyear",
        fileNamePrefix=desc,
        region=tile_coords,
        scale=10,
        crs="EPSG:32627",
        maxPixels=MAX_PIXELS
    )
    task.start()
    print(f"â–¶ Export started: {desc} (task {task.id})")
    return task

# ---------------------------------------------------------------------------
# 5) MAIN: PROCESS ONE ISLAND AT A TIME
# ---------------------------------------------------------------------------
def download_data():
    # skip if raw already present
    if glob.glob(os.path.join(RAW_DATA_DIR, "*.tif")):
        print("Raw data present; skipping export.")
        return

    ee.Initialize(project="earthenginecapeverde")

    for isl in islands:
        print(f"\n=== STARTING exports for island: {isl['name']} ===")
        tasks = []
        for tidx, tc in enumerate(tile_bbox(isl["coords"])):
            tasks.append(export_full_year(isl, tc, tidx))

        print("Monitoring export tasks for this islandâ€¦")
        while True:
            states = {t.id: t.status().get("state") for t in tasks}
            print(states)
            if all(s in ("COMPLETED", "FAILED") for s in states.values()):
                break
            time.sleep(10)

        print(f"\nâœ… Island '{isl['name']}' complete.")
        input("Please download these tiles from Google Drive and clear space. Press Enter to continue to the next islandâ€¦")

    print("\nðŸŽ‰ All islands processed. Export pipeline finished.")

if __name__ == "__main__":
    download_data()